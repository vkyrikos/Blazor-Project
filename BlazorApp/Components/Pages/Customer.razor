@page "/customers/{Id:int}"
@rendermode InteractiveServer
@using BlazorApp.Contracts.Api.Output
@using Microsoft.AspNetCore.Components
@using BlazorApp.Application.Interfaces
@using System.Text.Json
@using Microsoft.JSInterop
@inject ICustomerApi Api
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>Customer #@Id</h3>

@if (_loading)
{
    <p>Loading…</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
else if (_customer is not null)
{
    <div class="card" style="max-width: 720px; padding: 1rem;">
        <dl>
            <dt>Company</dt>
            <dd>@Show(_customer.CompanyName)</dd>
            <dt>Contact</dt>
            <dd>@Show(_customer.ContactName)</dd>
            <dt>Address</dt>
            <dd>@Show(_customer.Address)</dd>
            <dt>City</dt>
            <dd>@Show(_customer.City)</dd>
            <dt>Region</dt>
            <dd>@Show(_customer.Region)</dd>
            <dt>Postal Code</dt>
            <dd>@Show(_customer.PostalCode)</dd>
            <dt>Country</dt>
            <dd>@Show(_customer.Country)</dd>
            <dt>Phone</dt>
            <dd>@Show(_customer.Phone)</dd>
            <dt>Created</dt>
            <dd>@FormatDate(_customer.CreatedAt)</dd>
            <dt>Updated</dt>
            <dd>@FormatDate(_customer.UpdatedAt)</dd>
            <dt>Is Deleted</dt>
            <dd>@(_customer.IsDeleted ? "Yes" : "No")</dd>
        </dl>

        <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap:wrap;">
            <button @onclick="Edit" disabled="@_busy">Edit</button>
            <button @onclick="Delete" disabled="@_busy" style="background:#b40000;color:white;">Delete</button>
            <button @onclick="Reload" disabled="@_busy">Refresh</button>
            <a href="/customers" style="align-self:center; margin-left:.5rem;">Back</a>
        </div>
    </div>
}
else
{
    <p>No data found.</p>
}

@code {
    [Parameter] public int Id { get; set; }

    private CustomerDto? _customer;
    private bool _loading;
    private string? _error;
    private bool _busy;

    protected override async Task OnParametersSetAsync()
    {
        await Load();
    }

    private async Task Reload() => await Load();

    private async Task Load()
    {
        _loading = true;
        _error = null;

        try
        {
            _customer = await Api.GetCustomerAsync(Id);
        }
        catch (OperationCanceledException)
        {
            _error = "Request was canceled.";
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Edit()
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"Proceed to edit customer #{Id}?");
        if (!ok) return;

        Nav.NavigateTo($"/customers/{Id}/edit");
    }

    private async Task Delete()
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete customer #{Id}? This cannot be undone.");
        if (!ok) return;

        _busy = true;
        try
        {
            await Api.DeleteCustomerAsync(Id);
            Nav.NavigateTo("/customers");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private static string Show(string? s) => string.IsNullOrWhiteSpace(s) ? "—" : s;

    private static string FormatDate(DateTime? dt) =>
        dt.HasValue && dt.Value != default
            ? dt.Value.ToString("yyyy-MM-dd HH:mm")
            : "—";
}
