@page "/customers/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.Json
@using BlazorApp.Application.Interfaces
@inject ICustomerApi Api

<h3>Add Customer</h3>

<EditForm EditContext="_editContext" OnValidSubmit="Save" @key="_customer">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label>Contact Name</label>
        <input value="@_customer.ContactName" @onchange="e => _customer.ContactName = e.Value?.ToString()" />
    </div>
    <div>
        <label>Country</label>
        <input value="@_customer.Country" @onchange="e => _customer.Country = e.Value?.ToString()" />
    </div>
    <div>
        <label>Region</label>
        <input value="@_customer.Region" @onchange="e => _customer.Region = e.Value?.ToString()" />
    </div>
    <div>
        <label>City</label>
        <input value="@_customer.City" @onchange="e => _customer.City = e.Value?.ToString()" />
    </div>
    <div>
        <label>Address</label>
        <input value="@_customer.Address" @onchange="e => _customer.Address = e.Value?.ToString()" />
    </div>
    <div>
        <label>PostalCode</label>
        <input value="@_customer.PostalCode" @onchange="e => _customer.PostalCode = e.Value?.ToString()" />
    </div>
    <div>
        <label>Phone</label>
        <input value="@_customer.Phone" @onchange="e => _customer.Phone = e.Value?.ToString()" />
    </div>
    <div>
        <label>CompanyName</label>
        <input value="@_customer.CompanyName" @onchange="e => _customer.CompanyName = e.Value?.ToString()" />
    </div>

    <button type="submit">Save</button>
</EditForm>

<pre>@JsonSerializer.Serialize(_customer, new JsonSerializerOptions { WriteIndented = true })</pre>

@if (!string.IsNullOrWhiteSpace(_status))
{
    <p>@_status</p>
}

@code {
    private BlazorApp.Models.Customer _customer = new();
    private EditContext _editContext = default!;
    private string? _status;

    protected override void OnInitialized()
    {
        _editContext = new EditContext(_customer);
    }

    private async Task Save()
    {
        try
        {
            var created = await Api.UpsertCustomerAsync(_customer);

            _status = $"Saved. New Id: {created.Id}";

            // Clear the form correctly: replace model AND edit context, and re-key the form
            _customer = new();
            _editContext = new EditContext(_customer);
        }
        catch (Exception ex)
        {
            _status = $"Error: {ex.Message}";
        }
    }
}
